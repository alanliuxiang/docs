
= OCP 安装
:toc: manual
:toc-placement: preamble

OpenShift Container Platform  安装。


== Ansible hosts 文件编辑

登录Master节点执行如下命令，编辑 `/etc/ansible/hosts`：

[source, bash]
----
cat > /etc/ansible/hosts <<EOF
# hosts file for ocp.com
[OSEv3:children]
masters
etcd
nodes
nfs

[OSEv3:vars]
ansible_ssh_user=root
openshift_deployment_type=openshift-enterprise
deployment_type=openshift-enterprise
openshift_release=3.9.27

osm_use_cockpit=true
osm_cockpit_plugins=['cockpit-kubernetes']

osm_cluster_network_cidr=10.128.0.0/14
openshift_portal_net=172.30.0.0/16
openshift_master_api_port=8443
openshift_master_console_port=8443

openshift_master_cluster_public_hostname=master.example.com
openshift_master_cluster_hostname=master.example.com
openshift_master_default_subdomain=apps.example.com
openshift_master_identity_providers=[{'name': 'htpasswd_auth', 'login': 'true','challenge': 'true', 'kind': 'HTPasswdPasswordIdentityProvider', 'filename': '/etc/origin/master/htpasswd'}]
openshift_master_cluster_method=native

openshift_hosted_registry_selector='region=infra'
openshift_hosted_registry_replicas=1
openshift_hosted_registry_cert_expire_days=3650
openshift_hosted_manage_registry=true
openshift_hosted_registry_storage_kind=nfs
openshift_hosted_registry_storage_access_modes=['ReadWriteMany']
openshift_hosted_registry_storage_nfs_directory=/exports
openshift_hosted_registry_storage_nfs_options='*(rw,root_squash)'
openshift_hosted_registry_storage_volume_name=registry
openshift_hosted_registry_storage_volume_size=10Gi
oreg_url=registry.example.com/openshift3/ose-\${component}:\${version}
openshift_docker_additional_registries=registry.example.com
#openshift_docker_insecure_registries=registry.example.com
openshift_docker_blocked_registries=registry.access.redhat.com,docker.io
openshift_image_tag=3.9.27
openshift_examples_modify_imagestreams=true

#openshift_enable_service_catalog=true
#template_service_broker_install=true
openshift_service_catalog_image_prefix=registry.example.com/openshift3/ose-
openshift_service_catalog_image_version=3.9.27

ansible_service_broker_image_prefix=registry.example.com/openshift3/ose-
ansible_service_broker_image_tag=3.9.27
ansible_service_broker_etcd_image_prefix=registry.example.com/rhel7/
ansible_service_broker_registry_url=https://registry.example.com

template_service_broker_prefix=registry.example.com/openshift3/ose-
template_service_broker_version=3.9.27

openshift_hosted_etcd_storage_kind=nfs
openshift_hosted_etcd_storage_nfs_options="*(rw,root_squash,sync,no_wdelay)"
openshift_hosted_etcd_storage_nfs_directory=/exports
openshift_hosted_etcd_storage_volume_name=etcd
openshift_hosted_etcd_storage_access_modes=["ReadWriteOnce"]
openshift_hosted_etcd_storage_volume_size=1G
openshift_hosted_etcd_storage_labels={'storage': 'etcd'}

ansible_service_broker_local_registry_whitelist=['.*-apb$']
openshift_template_service_broker_namespaces=['openshift','tsb']

#openshift_hosted_router_replicas=1
openshift_router_selector='router=true'
openshift_registry_selector='infra=true'

#openshift_set_node_ip=True
openshift_disable_check=memory_availability,disk_availability,docker_image_availability,docker_storage,package_version
openshift_cockpit_deployer_prefix='openshift3/'
openshift_cockpit_deployer_version=3.9.27

#openshift_node_kubelet_args={'pods-per-core': ['10'], 'max-pods':['60']}
openshift_metrics_install_metrics=true
openshift_metrics_storage_kind=nfs
openshift_metrics_storage_access_modes=['ReadWriteOnce']
openshift_metrics_storage_host=nfs.example.com
openshift_metrics_storage_nfs_directory=/exports
openshift_metrics_storage_volume_name=metrics
openshift_metrics_storage_volume_size=10Gi
openshift_metrics_storage_labels={'storage': 'metrics'}
openshift_metrics_hawkular_hostname=hawkular-metrics.apps.example.com
openshift_metrics_image_prefix=registry.example.com/openshift3/
openshift_metrics_image_version=3.9.27

openshift_logging_install_logging=true
openshift_logging_storage_kind=nfs
openshift_logging_storage_access_modes=['ReadWriteOnce']
openshift_logging_storage_nfs_directory=/exports
openshift_logging_storage_nfs_options='*(rw,root_squash)'
openshift_logging_storage_volume_name=logging
openshift_logging_storage_volume_size=10Gi
openshift_logging_storage_labels={'storage': 'logging'}
openshift_logging_kibana_hostname=logging.apps.example.com
openshift_logging_es_cluster_size=1
openshift_logging_image_prefix=registry.example.com/openshift3/
openshift_logging_image_version=3.9.27
openshift_logging_es_memory_limit=1Gi


openshift_hosted_prometheus_deploy=true
openshift_prometheus_storage_kind=nfs
openshift_prometheus_storage_access_modes=['ReadWriteOnce']
openshift_prometheus_storage_nfs_directory=/exports
openshift_prometheus_storage_nfs_options='*(rw,root_squash)'
openshift_prometheus_storage_volume_name=prometheus
openshift_prometheus_storage_volume_size=10Gi
openshift_prometheus_storage_labels={'storage': 'prometheus'}
openshift_prometheus_storage_type='pvc'
openshift_prometheus_alertmanager_storage_kind=nfs
openshift_prometheus_alertmanager_storage_access_modes=['ReadWriteOnce']
openshift_prometheus_alertmanager_storage_nfs_directory=/exports
openshift_prometheus_alertmanager_storage_nfs_options='*(rw,root_squash)'
openshift_prometheus_alertmanager_storage_volume_name=prometheus-alertmanager
openshift_prometheus_alertmanager_storage_volume_size=10Gi
openshift_prometheus_alertmanager_storage_labels={'storage': 'prometheus-alertmanager'}
openshift_prometheus_alertmanager_storage_type='pvc'
openshift_prometheus_alertbuffer_storage_kind=nfs
openshift_prometheus_alertbuffer_storage_access_modes=['ReadWriteOnce']
openshift_prometheus_alertbuffer_storage_nfs_directory=/exports
openshift_prometheus_alertbuffer_storage_nfs_options='*(rw,root_squash)'
openshift_prometheus_alertbuffer_storage_volume_name=prometheus-alertbuffer
openshift_prometheus_alertbuffer_storage_volume_size=10Gi
openshift_prometheus_alertbuffer_storage_labels={'storage': 'prometheus-alertbuffer'}
openshift_prometheus_alertbuffer_storage_type='pvc'
openshift_prometheus_image_prefix=registry.example.com/openshift3/
openshift_prometheus_image_version=3.9.27
openshift_prometheus_proxy_image_prefix=registry.example.com/openshift3/
openshift_prometheus_proxy_image_version=3.9.27
openshift_prometheus_alertbuffer_image_prefix=registry.example.com/openshift3/
openshift_prometheus_alertbuffer_image_version=3.9.27
openshift_prometheus_altermanager_image_prefix=registry.example.com/openshift3/
openshift_prometheus_alertmanager_image_version=3.9.27
openshift_prometheus_node_exporter_image_prefix=registry.example.com/openshift3/
openshift_prometheus_node_exporter_image_version=3.9.27

openshift_web_console_prefix=registry.example.com/openshift3/ose-
openshift_web_console_version=3.9.27
openshift_clock_enabled=true

[etcd]
master.example.com

[masters]
master.example.com

[nodes]
master.example.com openshift_node_labels="{'region': 'master'}" 
node1.example.com openshift_node_labels="{'region': 'infra', 'zone': 'default','infra': 'true','router': 'true'}"
node2.example.com openshift_node_labels="{'region': 'primary', 'zone': 'default'}"

[nfs]
nfs.example.com
EOF
---- 

== 安装

[source, text]
----
# ansible-playbook /usr/share/ansible/openshift-ansible/playbooks/byo/openshift_facts.yml
----

