= 安装准备
:toc: manual

== 安装准备说明

.*软件安装需求*
[cols="2,5a"]
|===
|类型 |说明

|SELinux
|配置 SELinux(/etc/selinux/config)，确保:

* SELINUX=enforcing
* SELINUXTYPE=targeted

|DNS
|`/etc/hosts` 中添加静态域名

|DNA A record
|添加 A 记录

----
*.cloudapps.example.com. 300 IN  A 10.0.0.1
----

|NetworkManager
|可选择的，如果禁用，需要手动配置 DNS

|firewall
|推荐打开，对应 ansible inventory 中添加:

----
os_firewall_use_firewalld=True
----

|Storage
|NFS, GlusterFS, Ceph RBD, OpenStack Cinder, AWS Elastic Block Store (EBS), GCE Persistent Disks, iSCSI.

|安装包
|
----
# yum install wget git net-tools bind-utils yum-utils iptables-services bridge-utils bash-completion kexec-tools sos psacct
# yum update
# systemctl reboot
---- 

|Ansible Task
|
----
# yum install openshift-ansible
----

|docker
|
----
# yum install docker-1.13.1
# rpm -V docker-1.13.1
# docker version
----

|===

本部分提供两种安装方式：Ansible 执行前续安装，及 Bash 执行前续安装。

== Ansible 执行前续安装

本部分是在操作控制节点上进行。

=== 操作控制节点安装 Ansible

[source, text]
.*1 - 安装*
----
# yum install ansible
----

[source, bash]
.*2 - 验证是否已安装了 ansible 软件包*
----
$ rpm -qa | grep ansible
ansible-2.3.2.0-2.el7.noarch

$ ansible --version
ansible 2.3.2.0
  config file = /etc/ansible/ansible.cfg
  configured module search path = Default w/o overrides
  python version = 2.7.5 (default, May  3 2017, 07:55:04) [GCC 4.8.5 20150623 (Red Hat 4.8.5-14)]
----

=== 操作控制节点配置到各节点免密登录

[source, bash]
.*1 - 配置操作控制节点到各节点静态域名解析*
----
echo "192.168.122.101 master.example.com master" >> /etc/hosts
echo "192.168.122.102 infra.example.com infra" >> /etc/hosts
echo "192.168.122.103 nfs.example.com nfs" >> /etc/hosts
echo "192.168.122.105 node1.example.com node1" >> /etc/hosts
echo "192.168.122.106 node2.example.com node2" >> /etc/hosts
----

[source, text]
.*2 - 配置操作控制节点生成 SSH 所需之秘钥。命令如下，应答输入请直接输入回车*
----
# ssh-keygen
----

[source, bash]
.*3 - 配置到各节点免密登录*
----
for i in master infra nfs node1 node2; do ssh-copy-id $i; done;
----

=== 准备 Playbook 脚本

* link:pre-files/prepare_install.yml[pre-files/prepare_install.yml] - Ansible Playbook 脚本
* link:pre-files/inventory[pre-files/inventory] - 脚本组定义
* link:pre-files/conf/ocp.repo[pre-files/conf/ocp.repo] - 本地 yum 仓库地址
* link:pre-files/conf/ocp_rsa[pre-files/conf/ocp_rsa] - SSH 免密私钥
* link:pre-files/conf/ocp_rsa.pub[pre-files/conf/ocp_rsa.pub] - SSH 免密公钥
* link:pre-files/conf/docker-storage-setup[pre-files/conf/docker-storage-setup] - docker 存储配置文件
* link:pre-files/conf/openshift-cluster.conf[pre-files/conf/openshift-cluster.conf] - dnsmasq 配置文件
* link:pre-files/conf/example.com.crt[pre-files/conf/example.com.crt] 

如上文件目录结构为:

image:img/ocp-pre-files.png[]

=== 执行 Playbook 脚本

[source, bash]
----
ansible-playbook -i inventory prepare_install.yml
----

== Bash 执行前续安装

=== 控制节点静态域名配置

[source, text]
.*Master 上配置 hosts 内容如下*
----
echo "192.168.122.101 master.example.com master" >> /etc/hosts
echo "192.168.122.102 infra.example.com infra" >> /etc/hosts
echo "192.168.122.103 nfs.example.com nfs" >> /etc/hosts
echo "192.168.122.105 node1.example.com node1" >> /etc/hosts
echo "192.168.122.106 node2.example.com node2" >> /etc/hosts
echo "10.66.192.47 registry.example.com registry" >> /etc/hosts
echo "10.66.192.47 yum.example.com yum" >> /etc/hosts
----

=== Master 到其它节点互信

[source, text]
.*1. 生成 SSH 所需之秘钥。命令如下，应答输入请直接输入回车*
----
# ssh-keygen
----

[source, text]
.*2. 配置到各节点免密登录*
----
# for i in master infra nfs node1 node2 registry; do ssh-copy-id $i.example.com; done;
----

[source, text]
.*3. 免密登录验证*
----
# for i in master infra node1 nfs ; do ssh $i.example.com 'date'; done
----

=== 所有节点 hosts 文件拷贝

[source, text]
----
# for i in master infra nfs node1 ; do scp /etc/hosts root@$i.example.com:/etc/hosts ; done
----

=== 所有节点 yum 源配置

[source, text]
.*1. 控制节点创建 ocp.repo*
----
cat << EOF > ocp.repo
[rhel-7-server-rpms]
baseurl = http://yum.example.com/repo/rhel-7-server-rpms
enabled = 1
gpgcheck = 0
name = rhel-7-server-rpms

[rhel-7-server-extras-rpms]
baseurl = http://yum.example.com/repo/rhel-7-server-extras-rpms
enabled = 1
gpgcheck = 0
name = rhel-7-server-extras-rpms

[rhel-7-server-ose-3.10-rpms]
baseurl = http://yum.example.com/repo/rhel-7-server-ose-3.10-rpms
enabled = 1
gpgcheck = 0
name = rhel-7-server-ose-3.10-rpms

[rhel-7-fast-datapath-rpms]
baseurl = http://yum.example.com/repo/rhel-7-fast-datapath-rpms
enabled = 1
gpgcheck = 0
name = rhel-7-fast-datapath-rpms

[rhel-7-server-ansible-2.4-rpms]
baseurl = http://yum.example.com/repo/rhel-7-server-ansible-2.4-rpms
enabled = 1
gpgcheck = 0
name = rhel-7-server-ansible-2.4-rpms
EOF
----

[source, text]
.*2. 确保所有用户有可读权限*
----
# chmod a+x ocp.repo
----

[source, text]
.*3. 所有节点 yum 源配置*
----
# for i in master infra node1 nfs ; do scp ocp.repo root@$i.example.com:/etc/yum.repos.d/ ; done
----

[source, text]
.*4. 测试 yum 源配置*
----
# for i in master infra node1 nfs ; do ssh $i.example.com 'yum list | grep openshift-ansible ; echo' ; done
----

=== 安装软件包

[source, text]
.*1. yum 更新*
----
# for i in master infra node1 nfs ; do ssh $i.example.com 'yum update -y' ; done
----

[source, text]
.*2. 安装基本包*
----
# for i in master infra node1 nfs ; do ssh $i.example.com 'yum -y install wget git net-tools bind-utils yum-utils iptables-services bridge-utils bash-completion kexec-tools sos psacct vim tree; echo' ; done
----

[source, text]
.*3. Master 上安装 openshift-ansible*
----
# ssh master.example.com 'yum -y install openshift-ansible'
----

[source, text]
.*4. 重起所有节点*
----
# for i in infra node1 nfs master ; do ssh $i.example.com 'reboot' ; done
----

=== DNS 配置

[source, text]
.*1. 所有节点配置 DNS*
----
# for i in master infra node1 nfs ; do ssh $i.example.com 'nmcli connection modify eth0 ipv4.dns 10.66.192.47' ; done
----

[source, text]
.*2. 测试 DNS*
----
# for i in master infra node1 nfs ; do ssh $i.example.com 'dig master.example.com @10.66.192.47 +short' ; done
# for i in master infra node1 nfs ; do ssh $i.example.com 'dig infra.example.com @10.66.192.47 +short' ; done
# for i in master infra node1 nfs ; do ssh $i.example.com 'dig nfs.example.com @10.66.192.47 +short' ; done
# for i in master infra node1 nfs ; do ssh $i.example.com 'dig node1.example.com @10.66.192.47 +short' ; done
# for i in master infra node1 nfs ; do ssh $i.example.com 'dig registry.example.com @10.66.192.47 +short' ; done

# for i in master infra node1 nfs ; do ssh $i.example.com 'dig test.apps.example.com @10.66.192.47 +short' ; done
# for i in master infra node1 nfs ; do ssh $i.example.com 'dig xyz.apps.example.com @10.66.192.47 +short' ; done
----

=== 安装 Docker

[source, text]
.*1. 安装*
----
# for i in master infra node1 ; do ssh $i.example.com 'yum -y install docker'; done
----

[source, text]
.*2. 配置 Docker Storage(可选)*
----

----

[source, text]
.*3. 启动*
----
# for i in master infra node1 ; do ssh $i.example.com 'systemctl enable docker'; done
# for i in master infra node1 ; do ssh $i.example.com 'systemctl start docker'; done
----

[source, text]
.*4. 启动验证*
----
# for i in master infra node1 ; do ssh $i.example.com 'systemctl status docker'; done
# for i in master infra node1 ; do ssh $i.example.com 'systemctl is-active docker'; done
----

=== Docker 证书配置

[source, text]
.*1. 拷贝证书*
----
# for i in master infra node1 ; do scp example.com.crt root@$i.example.com:/etc/pki/ca-trust/source/anchors/ ; done
----

[source, text]
.*2. 更新信任自签名证书*
----
# for i in master infra node1 ; do ssh $i.example.com 'update-ca-trust extract'; done
----

[source, text]
.*3. 重起 Docker*
----
# for i in master infra node1 ; do ssh $i.example.com 'systemctl restart docker ; systemctl is-active docker'; done
# for i in master infra node1 ; do ssh $i.example.com 'systemctl is-enabled docker'; don
----

[source, text]
.*4. 镜像下载测试*
----
# for i in master infra node1 ; do ssh $i.example.com 'docker pull registry.example.com/rhscl/php-56-rhel7:latest'; done
----


== Ansible hosts 文件编辑

登录 Master 节点编辑 `/etc/ansible/hosts`。


=== Ansible Inventory 变量

[source, bash]
.*1 - 配置认证提供者*
----
openshift_master_identity_providers=[{'name': 'htpasswd_auth', 'login': 'true', 'challenge': 'true', 'kind': 'HTPasswdPasswordIdentityProvider'}]
----

[source, bash]
.*2 - Web Console 控制*
----
openshift_web_console_install=true
openshift_web_console_prefix=registry.example.com/openshift3/ose-
openshift_web_console_version=v3.10.14
----

[source, bash]
.*3 - 3.9 及以后的版本安装推荐使用 firewalld，如下参数开启 firewalld*
----
os_firewall_use_firewalld=True
----

[source, bash]
.*4 - 安装 Standalone Registry，忽略 WebConsole 等其它*
----
deployment_subtype=registry
----

=== Inventory 示例

|===
|Inventory | 说明

|link:hosts/hosts-3.10.45[hosts-3.10.45]
|OpenShift 3.10.45

|link:hosts/hosts-3.10.14[hosts-3.10.14]
|OpenShift 3.10.14

|link:hosts/hosts-3.9.30[hosts-3.9.30]
|OpenShift 3.9.30

|link:hosts/hosts-3.9.25[hosts-3.9.25]
|OpenShift 3.9.25

|link:hosts/hosts-3.9.14[hosts-3.9.14]
|OpenShift 3.9.14

|link:hosts/hosts-3.6[hosts-3.6]
|OpenShift 3.6
|===

== 前续安装验证

本部分在 master 上执行。

[source, text]
.*执行 prerequisites 验证*
----
# ansible-playbook -i hosts-3.10.14 /usr/share/ansible/openshift-ansible/playbooks/prerequisites.yml
----

