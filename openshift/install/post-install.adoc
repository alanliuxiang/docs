
= 后续配置
:toc: manual
:toc-placement: preamble

本部分包括安装完成后续的配置。本部分操作在 Master 结点上执行。


== 配置用户

[source, bash]
.*创建管理员用户*
----
htpasswd -b /etc/origin/master/htpasswd admin admin
oc login -u system:admin
oc adm policy add-role-to-user system:image-builder admin
oc adm policy add-role-to-user admin admin -n openshift
oc adm policy add-cluster-role-to-user admin admin
oc adm policy add-cluster-role-to-user cluster-admin admin
----

NOTE: 如果 htpasswd 不存在，需要安装 `httpd-tools` 包。

[source, bash]
.*创建普通用户*
----
htpasswd -b /etc/origin/master/htpasswd user01 redhat
htpasswd -b /etc/origin/master/htpasswd user02 redhat
oc login -u system:admin
oc adm policy add-role-to-user self-provisioner user01
oc adm policy add-role-to-user self-provisioner user02
----

== 重启
 
[source, bash]
.*重启 Master 节点服务*
----
# master-restart api
# master-restart controllers
# master-restart etcd
----

== Gitlab 安装与配置

[source, text]
.*安装*
----
# rpm -ivh gitlab-ee-10.4.0-ee.0.el7.x86_64.rpm
----

[source, bash]
.*修改/etc/gitlab/gitlab.rb将external_url设置成如下*
----
external_url 'http://git.example.com'
----

NOTE: 记得修改所有客户端的/etc/hosts表，加入 git.example.com 的地址。

[source, text]
.*执行如下命令完成 gitlab 配置及启动 gitlab*
----
# gitlab-ctl reconfigure
# gitlab-ctl start
----

NOTE: 启动完成后通过浏览器访问 http://git.example.com，第一次访问的时候会提示创建密码，密码必须是8位登录名是root。


== ImageStream 配置

=== php IS 配置示例

[source, text]
.*1 - 确保外部镜像仓库中的镜像*
----
# docker images | grep php
registry.example.com/rhscl/php-70-rhel7                        latest              49a451388c11        3 weeks ago         579 MB
registry.example.com/rhscl/php-56-rhel7                        latest              520f0e9ceee7        2 months ago        581 MB
----

[source, bash]
.*2 - 编辑 IS*
----
oc edit is php -n openshift 
----

NOTE: 编辑可删除多余的 Tag.

[source, bash]
.*3 - 重新导入 Image*
----
oc import-image php -n openshift --all
----

NOTE: 这一步时可选，Image 导入成功后，IS 描述中会由类似 `registry.example.com/rhscl/php-70-rhel7@sha256:f1816ef319ef2561686c7a9cfcc4f6fd4e876a0924b2ebac9b0c7edc7e41a89a` 的信息，这表明内部镜像仓库已经从外部仓库中拉取到了东西。 

[source, bash]
.*4 - 测试*
----
$ oc login https://master.example.com:8443 -u user01 -p redhat

$ oc new-project test01

$ oc new-app php:7.0~http://git.example.com/open-source/php-helloworld.git --name=php-helloworld
$ oc expose svc/php-helloworld

$ oc get routes
NAME             HOST/PORT                                PATH      SERVICES         PORT       TERMINATION   WILDCARD
php-helloworld   php-helloworld-test01.apps.example.com             php-helloworld   8080-tcp                 None

$ curl http://php-helloworld-test01.apps.example.com
Hello, World! php version is 7.0.27

$ oc delete project test01
----

== PV 设置

[source, text]
.*1. NFS 服务器创建外挂节点(link:post-files/config-nfs.sh[config-nfs.sh])，并验证*
----
# ./config-nfs.sh

# showmount -e | grep pv
/srv/nfs/user-vols/pv40          *
/srv/nfs/user-vols/pv39          *
/srv/nfs/user-vols/pv38          *
/srv/nfs/user-vols/pv37          *
/srv/nfs/user-vols/pv36          *
/srv/nfs/user-vols/pv35          *
/srv/nfs/user-vols/pv34          *
/srv/nfs/user-vols/pv33          *
/srv/nfs/user-vols/pv32          *
/srv/nfs/user-vols/pv31          *
/srv/nfs/user-vols/pv30          *
/srv/nfs/user-vols/pv29          *
/srv/nfs/user-vols/pv28          *
/srv/nfs/user-vols/pv27          *
/srv/nfs/user-vols/pv26          *
/srv/nfs/user-vols/pv25          *
/srv/nfs/user-vols/pv24          *
/srv/nfs/user-vols/pv23          *
/srv/nfs/user-vols/pv22          *
/srv/nfs/user-vols/pv21          *
/srv/nfs/user-vols/pv20          *
/srv/nfs/user-vols/pv19          *
/srv/nfs/user-vols/pv18          *
/srv/nfs/user-vols/pv17          *
/srv/nfs/user-vols/pv16          *
/srv/nfs/user-vols/pv15          *
/srv/nfs/user-vols/pv14          *
/srv/nfs/user-vols/pv13          *
/srv/nfs/user-vols/pv12          *
/srv/nfs/user-vols/pv10          *
/srv/nfs/user-vols/pv9           *
/srv/nfs/user-vols/pv8           *
/srv/nfs/user-vols/pv7           *
/srv/nfs/user-vols/pv5           *
/srv/nfs/user-vols/pv4           *
/srv/nfs/user-vols/pv3           *
/srv/nfs/user-vols/pv2           *
/srv/nfs/user-vols/pv1           *
/srv/nfs/user-vols/pv6           *
/srv/nfs/user-vols/pv11          *
----

[source, text]
.*2. 以 system:admin 用户登录，生成 PV 创建脚本(link:post-files/pvs.sh[pvs.sh])*
----
# ./pvs.sh
# cat /root/pvs/* | oc create -f -
----

NOTE: 执行此脚本会创建 10 个 5G 大小，ReadWriteOnce PV，10 个 5G 大小，ReadWriteMany PV，10 个 10G 大小，ReadWriteOnce PV，10 个 10G 大小，ReadWriteMany PV。

[source, text]
.*3. 验证创建成功的 PV*
----
# oc get pv | grep pv
pv1              5Gi        RWO            Recycle          Available                                                                    11m
pv10             5Gi        RWO            Recycle          Available                                                                    11m
pv11             5Gi        RWX            Retain           Available                                                                    11m
pv12             5Gi        RWX            Retain           Available                                                                    11m
pv13             5Gi        RWX            Retain           Available                                                                    11m
pv14             5Gi        RWX            Retain           Available                                                                    11m
pv15             5Gi        RWX            Retain           Available                                                                    11m
pv16             5Gi        RWX            Retain           Available                                                                    11m
pv17             5Gi        RWX            Retain           Available                                                                    11m
pv18             5Gi        RWX            Retain           Available                                                                    11m
pv19             5Gi        RWX            Retain           Available                                                                    11m
pv2              5Gi        RWO            Recycle          Available                                                                    11m
pv20             5Gi        RWX            Retain           Available                                                                    11m
pv21             10Gi       RWO            Recycle          Available                                                                    11m
pv22             10Gi       RWO            Recycle          Available                                                                    11m
pv23             10Gi       RWO            Recycle          Available                                                                    11m
pv24             10Gi       RWO            Recycle          Available                                                                    11m
pv25             10Gi       RWO            Recycle          Available                                                                    11m
pv26             10Gi       RWO            Recycle          Available                                                                    11m
pv27             10Gi       RWO            Recycle          Available                                                                    11m
pv28             10Gi       RWO            Recycle          Available                                                                    11m
pv29             10Gi       RWO            Recycle          Available                                                                    11m
pv3              5Gi        RWO            Recycle          Available                                                                    11m
pv30             10Gi       RWO            Recycle          Available                                                                    11m
pv31             10Gi       RWX            Retain           Available                                                                    11m
pv32             10Gi       RWX            Retain           Available                                                                    11m
pv33             10Gi       RWX            Retain           Available                                                                    11m
pv34             10Gi       RWX            Retain           Available                                                                    11m
pv35             10Gi       RWX            Retain           Available                                                                    11m
pv36             10Gi       RWX            Retain           Available                                                                    11m
pv37             10Gi       RWX            Retain           Available                                                                    11m
pv38             10Gi       RWX            Retain           Available                                                                    11m
pv39             10Gi       RWX            Retain           Available                                                                    11m
pv4              5Gi        RWO            Recycle          Available                                                                    11m
pv40             10Gi       RWX            Retain           Available                                                                    11m
pv5              5Gi        RWO            Recycle          Available                                                                    11m
pv6              5Gi        RWO            Recycle          Available                                                                    11m
pv7              5Gi        RWO            Recycle          Available                                                                    11m
pv8              5Gi        RWO            Recycle          Available                                                                    11m
pv9              5Gi        RWO            Recycle          Available                                                                    11m
----
