
= 创建 yum 源
:toc: manual

本部分下载 OpenShift 所需要的安装包，并基于http 服务器创建本地 yum 源。

== 绑定订阅账户

[source, text]
.*注册账户*
----
# subscription-manager register --username=<user_name> --password=<password>
----

[source, text]
.*查找包含 OpenShift 订阅的 Pool ID*
----
# subscription-manager list --available --matches '*OpenShift Container Platform*' 
----

[source, text]
.*绑定 Pool ID*
----
# subscription-manager attach --pool=<YOUR_POOL_ID>
----

=== 启用 OpenShift 需要的 Repo

[source, text]
.*禁止所有的 repo*
----
# subscription-manager repos --disable="*"
---- 

[source, text]
.*查看是否还有未被禁止的 repo*
----
# yum repolist
---- 

[source, text]
.*如果还有未被禁止的 repo，手工禁止它*
----
# yum-config-manager --disable <repo_id>
# yum-config-manager --disable \*
---- 

== 创建本地 YUM 源

=== 同步安装包到本地目录

[source, bash]
.*1 - 创建本地目录*
----
# mkdir -p /opt/ose
----

[source, bash]
.*2 - 启用 OCP 所需的 repo*
----
# subscription-manager repos \
    --enable="rhel-7-server-rpms" \
    --enable="rhel-7-server-extras-rpms" \
    --enable="rhel-7-fast-datapath-rpms" \
    --enable="rhel-7-server-ose-3.9-rpms"
----

[source, bash]
.*3 - 下载安装包到本地目录*
----
for repo in \
rhel-7-server-rpms \
rhel-7-server-extras-rpms \
rhel-7-fast-datapath-rpms \
rhel-7-server-ose-3.9-rpms
do
reposync -lm --repoid=${repo} --download_path=/opt/ose
createrepo -v /opt/ose/${repo} -o /opt/ose/${repo}
done
----

NOTE: 如果 reposync 不存在，可以通过 `yum install -y yum-utils` 安装 reposync 包。

NOTE: `reposync -p /opt/ose -n` 仅下载 OpenShift 需要的最新 Repo; `reposync -p /var/www/html/repo -r <REPOID> -l` 基于已从在的目录同步。

[source, bash]
.*4 - 执行如下命令更新 repodata*
----
createrepo --workers=5 /opt/ose/
----

=== 安装配置 httpd

[source, bash]
.*1 - 安装 httpd*
----
yum -y install httpd
----

[source, bash]
.*2 - 创建 httpd 配置文件，以发布 YUM 源*
----
cat << EOF > /etc/httpd/conf.d/yum.conf
Alias /repo "/opt/ose"
<Directory "/opt/ose">
  Options +Indexes +FollowSymLinks
  Require all granted
</Directory>
<Location /repo>
  SetHandler None
</Location>
EOF
----

[source, bash]
.*3- 重启 httpd，使修改生效*
----
systemctl enable httpd
systemctl restart httpd
----

== 测试 YUM 源配置


[source, bash]
.*1 - 在任意 Linux 节点上添加如下配置*
----
cat << EOF > /etc/yum.repos.d/ocp.repo
[rhel-7-server-rpms]
baseurl = http://yum.example.com/repo/rhel-7-server-rpms
enabled = 1
gpgcheck = 0
name = rhel-7-server-rpms

[rhel-7-server-extras-rpms]
baseurl = http://yum.example.com/repo/rhel-7-server-extras-rpms
enabled = 1
gpgcheck = 0
name = rhel-7-server-extras-rpms

[rhel-7-fast-datapath-rpms]
baseurl = http://yum.example.com/repo/rhel-7-fast-datapath-rpms
enabled = 1
gpgcheck = 0
name = rhel-7-fast-datapath-rpms

[rhel-7-server-ose-3.9-rpms]
baseurl = http://yum.example.com/repo/rhel-7-server-ose-3.9-rpms
enabled = 1
gpgcheck = 0
name = rhel-7-server-ose-3.9-rpms
EOF
----

执行输出如下命令测试 YUM 源配置

[source, bash]
.*2 - 执行输出如下命令测试 YUM 源配置*
----
yum list | grep -i atomic-openshift
----
