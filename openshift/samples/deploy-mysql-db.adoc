= 部署 mysql 数据库
:toc: manual

== NFS 服务器配置

[source, bash]
.*1. 准备脚本 link:files/config-nfs.sh[config-nfs.sh]*
----
#!/usr/bin/sh

export_dir="/var/export/data/mysqlvol"
export_file="/etc/exports.d/mysqlvol.exports"

if [ -d ${export_dir} ]; then
  echo "Export directory ${export_dir} already exist."
else
  mkdir -p ${export_dir}
  chown nfsnobody:nfsnobody ${export_dir}
  chmod 700 ${export_dir}
  echo "Export directory ${export_dir} created."
fi

if [ -d ${export_file} ]; then
  echo "Export file ${export_file} already exist."
else
  echo "${export_dir} *(rw,async,all_squash)" > ${export_file}
  exportfs -a
fi
----

[source, bash]
.*2. 执行脚本*
----
# ./config-nfs.sh
----

[source, bash]
.*3. 验证新创建的 /var/export/data/mysqlvol 在 export 列表里面*
----
# showmount -e
...
/var/export/data/mysqlvol        *
----

[source, bash]
.*4. 客户端(计算节点) mount 测试*
----
# mount -t nfs nfs.example.com:/var/export/data/mysqlvol /mnt
----

== 创建工程

[source, bash]
.*1 - 登录 CLI*
----
$ oc login https://master.example.com:8443 -u kylin -p redhat
----

[source, bash]
.*2 - oc new-project 创建工程*
----
$ oc new-project test-mysql
----

== 创建 PV/PVC

[source, bash]
.*1 - 创建 sample-volume.yaml*
----
cat << EOF > sample-volume.yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: sample-volume 
spec:
  capacity:
    storage: 2Gi 
  accessModes:
  - ReadWriteOnce 
  nfs: 
    path: /var/export/data/test-mysql
    server: nfs.example.com 
  persistentVolumeReclaimPolicy: Recycle
EOF
----

[source, bash]
.*2 - oc create -f 创建 PV*
----
$ oc create -f sample-volume.yaml 
persistentvolume "sample-volume" created
----

[source, bash]
.*3 - 创建 sample-claim.yaml*
----
cat << EOF > sample-claim.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: sample-claim
spec:
  accessModes:
    - ReadWriteOnce 
  resources:
    requests:
      storage: 2Gi
EOF
----

[source, bash]
.*4 - oc create -f 创建 PVC*
----
$ oc create -f sample-claim.yaml 
persistentvolumeclaim "sample-claim" created
----

[source, bash]
.*5 - oc get 验证 PV/PVC*
----
$ oc get pv
NAME            CAPACITY   ACCESSMODES   RECLAIMPOLICY   STATUS    CLAIM                          STORAGECLASS   REASON    AGE
sample-volume   2Gi        RWO           Recycle         Bound     test-mysql/sample-claim                            8m

$ oc get pvc
NAME           STATUS    VOLUME          CAPACITY   ACCESSMODES   STORAGECLASS   AGE
sample-claim   Bound     sample-volume   2Gi        RWO                          2m
----

== 部署 mysql

[source, yaml]
.*1 - 创建 pod-mysql.yaml，内容如下*
----
apiVersion: v1
kind: Pod
metadata:
  name: mysql
  labels:
    name: mysql
spec:
  containers:
    - resources:
        limits :
          cpu: 0.5
      image: "registry.example.com/rhscl/mysql-57-rhel7:latest"
      name: mysql
      env:
        - name: MYSQL_ROOT_PASSWORD
          value: redhat
        - name: MYSQL_USER
          value: test_user
        - name: MYSQL_PASSWORD
          value: test_pass
        - name: MYSQL_DATABASE
          value: test_db
      ports:
        - containerPort: 3306
          name: mysql
      volumeMounts:
        - name: mysql-persistent-storage
          mountPath: /var/export/data/test-mysql
  volumes:
    - name: mysql-persistent-storage
      persistentVolumeClaim:
        claimName: sample-claim
----

[source, bash]
.*2 - 创建 Mysql Pod*
----
$ oc create -f pod-mysql.yaml
----

[source, yaml]
.*3 - 创建 service-mysql.yaml，内容如下*
----
apiVersion: v1
kind: Service
metadata:
  labels:
    name: mysql
  name: mysql
spec:
  ports:
    - port: 3306
  selector:
    name: mysql
----

[source, bash]
.*4 - 创建 Mysql Service*
----
$ oc create -f service-mysql.yaml
----

[source, bash]
.*5 - 查看部署情况*
----
$ oc get all
NAME       READY     STATUS    RESTARTS   AGE
po/mysql   1/1       Running   0          17m

NAME        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE
svc/mysql   ClusterIP   172.30.58.170   <none>        3306/TCP   9m
----

== 配置 NodePort，使 mysql 外部可见

[source, bash]
.*1 - oc edit svc 配置 NodePort，添加 nodePort: 30306，修给 type 从 ClusterIP 到 NodePort*
----
$ oc edit svc mysql

apiVersion: v1
kind: Service
metadata:
  creationTimestamp: 2018-06-26T02:50:25Z
  labels:
    name: mysql
  name: mysql
  namespace: test-mysql
  resourceVersion: "2600936"
  selfLink: /api/v1/namespaces/test-mysql/services/mysql
  uid: ad8a7ca7-78eb-11e8-b08c-fa163e29efd9
spec:
  clusterIP: 172.30.58.170
  externalTrafficPolicy: Cluster
  ports:
  - name: 3306-tcp
    nodePort: 30306
    port: 3306
    protocol: TCP
    targetPort: 3306
  selector:
    name: mysql
  sessionAffinity: None
  type: NodePort
status:
  loadBalancer: {}
----

[source, text]
.*2 - oc describe svc*
----
$ oc describe svc mysql
Name:                     mysql
Namespace:                test-mysql
Labels:                   name=mysql
Annotations:              <none>
Selector:                 name=mysql
Type:                     NodePort
IP:                       172.30.58.170
Port:                     3306-tcp  3306/TCP
TargetPort:               3306/TCP
NodePort:                 3306-tcp  30306/TCP
Endpoints:                10.244.8.38:3306
Session Affinity:         None
External Traffic Policy:  Cluster
----

[source, text]
.*3 - 外部连接测试*
----
$ mysql -h172.16.22.102 -utest_user -ptest_pass -P30306
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MySQL connection id is 5
Server version: 5.7.21 MySQL Community Server (GPL)

Copyright (c) 2000, 2017, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MySQL [(none)]> 
----

[source, text]
.*4 - 创建数据库/表*
----
MySQL [(none)]> show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| test_db            |
+--------------------+
2 rows in set (0.01 sec)

MySQL [(none)]> use test_db;
Database changed

MySQL [test_db]> create table labs(id int, name varchar(30));
Query OK, 0 rows affected (0.04 sec)

MySQL [test_db]> insert into labs(id, name) values(101, 'OpenShift'),(102, 'OpenStack');
Query OK, 2 rows affected (0.01 sec)
Records: 2  Duplicates: 0  Warnings: 0

MySQL [test_db]> select * from labs;
+------+-----------+
| id   | name      |
+------+-----------+
|  101 | OpenShift |
|  102 | OpenStack |
+------+-----------+
2 rows in set (0.01 sec)
----

