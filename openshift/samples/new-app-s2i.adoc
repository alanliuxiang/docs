= 通过 S2I 创建容器化的应用
:toc: manual

== 创建工程，部署应用

[source, text]
.*oc new-project 创建工程*
----
# oc new-project s2i
----

[source, text]
.*oc new-app 使用程序代码创建应用*
----
# oc new-app php:latest~https://github.com/jbosschina/php-helloworld.git
----

[source, text]
.*oc describe bc/php-helloworld*
----
$ oc describe bc/php-helloworld
Name:		php-helloworld
Namespace:	s2i
Created:	About a minute ago
Labels:		app=php-helloworld
Annotations:	openshift.io/generated-by=OpenShiftNewApp
Latest Version:	1

Strategy:	Source
URL:		https://github.com/jbosschina/php-helloworld.git
From Image:	ImageStreamTag openshift/php:latest
Output to:	ImageStreamTag php-helloworld:latest

Build Run Policy:	Serial
Triggered by:		Config, ImageChange
Webhook Generic:
	URL:		https://192.168.42.107:8443/apis/build.openshift.io/v1/namespaces/s2i/buildconfigs/php-helloworld/webhooks/hj6t5btSVCwvU_QoCLMi/generic
	AllowEnv:	false
Webhook GitHub:
	URL:	https://192.168.42.107:8443/apis/build.openshift.io/v1/namespaces/s2i/buildconfigs/php-helloworld/webhooks/60FUxBwUCDb7R5jUx4zd/github

Build			Status		Duration		Creation Time
php-helloworld-1 	running 	running for 1m36s 	2018-02-11 19:11:54 +0800 CST

Events:
  FirstSeen	LastSeen	Count	From			SubObjectPath	Type		Reason				Message
  ---------	--------	-----	----			-------------	--------	------				-------
  1m		1m		1	buildconfig-controller			Warning		
----

[source, text]
.*oc logs php-helloworld-1-build*
----
$ oc logs php-helloworld-1-build
Cloning "https://github.com/jbosschina/php-helloworld.git" ...
	Commit:	7c6da76701f8bfbcf0f7c8307cbcaec753c303b3 (first commit)
	Author:	kylin <kylinsoong.1214@gmail.com>
	Date:	Sun Feb 11 18:03:23 2018 +0800
---> Installing application source...
=> sourcing 20-copy-config.sh ...
---> 11:13:05     Processing additional arbitrary httpd configuration provided by s2i ...
=> sourcing 00-documentroot.conf ...
=> sourcing 50-mpm-tuning.conf ...
=> sourcing 40-ssl-certs.sh ...
Pushing image 172.30.1.1:5000/s2i/php-helloworld:latest ...
Pushed 0/6 layers, 5% complete
Pushed 1/6 layers, 17% complete
Pushed 2/6 layers, 35% complete
Pushed 3/6 layers, 57% complete
Pushed 4/6 layers, 77% complete
Pushed 5/6 layers, 100% complete
Pushed 6/6 layers, 100% complete
Push successful
----

[source, text]
.*oc describe dc/php-helloworld*
----
$ oc describe dc/php-helloworld
Name:		php-helloworld
Namespace:	s2i
Created:	4 minutes ago
Labels:		app=php-helloworld
Annotations:	openshift.io/generated-by=OpenShiftNewApp
Latest Version:	1
Selector:	app=php-helloworld,deploymentconfig=php-helloworld
Replicas:	1
Triggers:	Config, Image(php-helloworld@latest, auto=true)
Strategy:	Rolling
Template:
Pod Template:
  Labels:	app=php-helloworld
		deploymentconfig=php-helloworld
  Annotations:	openshift.io/generated-by=OpenShiftNewApp
  Containers:
   php-helloworld:
    Image:		172.30.1.1:5000/s2i/php-helloworld@sha256:d06ff8421b194c7bc78b16564b9a02d85b120078a2505ea3c71028f1307874f5
    Ports:		8080/TCP, 8443/TCP
    Environment:	<none>
    Mounts:		<none>
  Volumes:		<none>

Deployment #1 (latest):
	Name:		php-helloworld-1
	Created:	3 minutes ago
	Status:		Complete
	Replicas:	1 current / 1 desired
	Selector:	app=php-helloworld,deployment=php-helloworld-1,deploymentconfig=php-helloworld
	Labels:		app=php-helloworld,openshift.io/deployment-config.name=php-helloworld
	Pods Status:	1 Running / 0 Waiting / 0 Succeeded / 0 Failed

Events:
  FirstSeen	LastSeen	Count	From				SubObjectPath	Type		Reason			Message
  ---------	--------	-----	----				-------------	--------	------			-------
  3m		3m		1	deploymentconfig-controller			Normal		DeploymentCreated	Created new replication controller "php-helloworld-1" for version 1
----

[source, text]
.*oc describe svc/php-helloworld*
----
$ oc describe svc/php-helloworld
Name:			php-helloworld
Namespace:		s2i
Labels:			app=php-helloworld
Annotations:		openshift.io/generated-by=OpenShiftNewApp
Selector:		app=php-helloworld,deploymentconfig=php-helloworld
Type:			ClusterIP
IP:			172.30.247.233
Port:			8080-tcp	8080/TCP
Endpoints:		172.17.0.3:8080
Port:			8443-tcp	8443/TCP
Endpoints:		172.17.0.3:8443
Session Affinity:	None
Events:			<none>
----

== 创建路由并测试

[source, text]
.*创建路由*
----
$ oc expose svc/php-helloworld
$ oc get routes
NAME             HOST/PORT                                  PATH      SERVICES         PORT       TERMINATION   WILDCARD
php-helloworld   php-helloworld-s2i.192.168.42.107.nip.io             php-helloworld   8080-tcp                 None
----

[source, text]
.*访问测试*
----
$ curl http://php-helloworld-s2i.192.168.42.107.nip.io
Hello, World! php version is 7.0.10
----

[source, text]
.*重新开始 S2I*
----
$ oc start-build php-helloworld
----

[source, text]
.*访问测试*
----
$ curl http://php-helloworld-s2i.192.168.42.107.nip.io
Hello, World! php version is 7.0.10
A change is a coming!
----
